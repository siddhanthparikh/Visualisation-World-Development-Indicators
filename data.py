import pandas as pd
import numpy as np
import scipy
import numpy as np
import pandas as pd
import datetime
from datetime import timezone
from sklearn.cluster import KMeans
from sklearn.decomposition import PCA
from sklearn.manifold import MDS
from sklearn.preprocessing import MinMaxScaler
from sklearn.metrics.pairwise import pairwise_distances
import time

data = None
cache = dict()

def get_frame(datapath):
    global data
    if data is None:
        data = pd.read_csv(datapath)
    return data

def load_dataset(datapath):
    frame =get_frame(datapath)
    frame = frame.iloc[:,[0,1,2,3,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63]]
    rows_req = ["2005 PPP conversion factor, GDP (LCU per international $)","2005 PPP conversion factor, private consumption (LCU per international $)","Adjusted net national income (annual % growth)","Adjusted net national income (constant 2010 US$)","Adjusted net national income (current US$)","Adjusted net national income per capita (annual % growth)","Adjusted net national income per capita (constant 2010 US$)","Adjusted net national income per capita (current US$)","Adjusted saving (% of GNI)","Adjusted saving (current US$)","Agriculture value added per worker (constant 2010 US$)","Aid flows at constant US$","Aid flows at current US$","Average grace period on new external debt","Average grant element on new external debt","Average interest on new external debt","Average maturity on new external debt","Balance of Payments (ratios to GDP)","Balance of payments current account","Changes in net reserves (BoP, current US$)","Concessional debt (% of total external debt)","Debt Interest arrears","Debt Interest rescheduled (capitalized)","Debt Princial arrears","Debt Principal rescheduled","Debt commitments","Debt disbursement","Debt forgiveness grants (current US$)","Debt forgiveness or reduction","Debt interest payment","Debt net flows (disbursements - principal repayments)","Debt net tranfers (disbursements - principal repayments - interest payments)","Debt principal payment","Debt service (PPG and IMF only, % of exports, excluding workers\' remittances)","Debt service (principal + interest payments)","Debt stock","Debt stock flow reconciliation","Debt stock rescheduled (current US$)","Exports as a capacity to import (constant LCU)","External debt stocks (% of GNI)","External debt stocks (% of exports of goods, services and income)","Foreign direct investment, net (BoP, current US$)","Foreign direct investment, net inflows (% of GDP)","Foreign direct investment, net inflows (BoP, current US$)","Foreign direct investment, net outflows (% of GDP)","Foreign direct investment, net outflows (BoP, current US$)","GDP (constant LCU)","GDP (current LCU)","GDP expenditure (% of GDP)","GDP expenditure (constant 2010 US$)","GDP expenditure (constant LCU)","GDP expenditure (current LCU)","GDP growth rate","GDP per capita (constant 2010 US$)","GDP per capita (constant LCU)","GDP per capita (current LCU)","GDP per capita (current US$)","GDP per capita growth (annual %)","GDP per capita, PPP (constant 2011 international $)","GDP per capita, PPP (current international $)","GDP production (% of GDP)","GDP production (annual % growth)","GDP production (constant 2010 US$)","GDP production (constant LCU)","GDP production (current LCU)","GDP production (current US$)","GDP: linked series (current LCU)","GNI (constant 2010 US$)","GNI (constant LCU)","GNI (current LCU)","GNI (current US$)","GNI growth (annual %)","GNI per capita (constant 2010 US$)","GNI per capita (constant LCU)","GNI per capita (current LCU)","GNI per capita growth (annual %)","GNI per capita in PPP dollars","GNI per capita, Atlas method (current US$)","GNI per capita, PPP (constant 2011 international $)","GNI, Atlas method (current US$)","GNI, PPP (constant 2011 international $)","Grants, excluding technical cooperation (BoP, current US$)","Gross Domestic Product","Gross National Income in PPP dollars","Gross domestic income (constant LCU)","Gross domestic savings (current LCU)","Gross national expenditure deflator (base year varies by country)","Gross savings (% of GDP)","Gross savings (% of GNI)","Gross savings (current LCU)","Gross savings (current US$)","Gross value added at basic prices (GVA) (constant LCU)","Gross value added at basic prices (GVA) (current LCU)","Household final consumption expenditure per capita (constant 2010 US$)","Household final consumption expenditure per capita growth (annual %)","IDA grants (current US$)","Industry (including construction), value added per worker (constant 2010 US$)","Interest payments on external debt (% of GNI)","Interest payments on external debt (% of exports of goods, services and income)","Manufacturing","Multilateral debt (% of total external debt)","Multilateral debt service (% of public and publicly guaranteed debt service)","Net ODA provided to the least developed countries (% of GNI)","Net ODA provided, to the least developed countries (current US$)","Net ODA provided, total (% of GNI)","Net ODA provided, total (constant 2015 US$)","Net ODA provided, total (current US$)","Net ODA received (% of GNI)","Net ODA received (% of central government expense)","Net ODA received (% of gross capital formation)","Net ODA received (% of imports of goods and services)","Net ODA received per capita (current US$)","Net capital account (BoP, current US$)","Net current transfers from abroad (current US$)","Net errors and omissions, adjusted (BoP, current US$)","Net financial account (BoP, current US$)","Net income from abroad (current US$)","Net official aid received (current US$)","Net official development assistance and official aid received (constant 2013 US$)","Net official development assistance and official aid received (current US$)","Net official development assistance received (current US$)","Net primary income (Net income from abroad) (constant LCU)","Net primary income (Net income from abroad) (current LCU)","Net secondary income (Net current transfers from abroad) (constant LCU)","Net secondary income (Net current transfers from abroad) (current LCU)","Net taxes on products (current US$)","PPP conversion factor (GDP) to market exchange rate ratio","PPP conversion factor, GDP (LCU per international $)","PPP conversion factor, private consumption (LCU per international $)","Portfolio equity, net inflows (BoP, current US$)","Portfolio investment, excluding LCFAR (BoP, current US$)","Present value of external debt (% of GNI)","Present value of external debt (% of exports of goods, services and income)","Product by expenditure (constant PPP)","Product by expenditure (current PPP)","Profit remittances on FDI (current US$)","Public and publicly guaranteed debt service (% of GNI)","Public and publicly guaranteed debt service (% of exports, excluding workers\' remittances)","Savings (% of GDP)","Savings (current US$)","Services, value added per worker (constant 2010 US$)","Short-term debt (% of exports of goods, services and income)","Short-term debt (% of total external debt)","Short-term debt (% of total reserves)","Taxes less subsidies on products (constant LCU)","Taxes less subsidies on products (current LCU)","Technical cooperation grants (BoP, current US$)","Terms of trade adjustment (constant LCU)","Total amount of debt rescheduled (current US$)","Total debt service (% of GNI)","Total debt service (% of exports of goods, services and income)","Total reserves (% of total external debt)","Total reserves (includes gold, current US$)","Total reserves in months of imports","Total reserves minus gold (current US$)","Trade (% of GDP)","Trade in services","Undisbursed debt","Adjusted net enrollment rate, primary (% of primary school age children)","Adolescents out of school (% of lower secondary school age)","All education staff compensation (% of total expenditure in public institutions)","Children out of school","Children out of school (% of primary school age)","Completion rate","Compulsory education, duration (years)","Current education expenditure (% of total expenditure in public institutions)","Educational attainment, population 25+, (%) (cumulative)","Enrollment ratio","Expenditure per student","Government expenditure on education (% of government expenditure)","Intake rate in grade 1","Literacy rate","Over-age students, primary (% of enrollment)","Persistence to grade 5 (% of cohort)","Persistence to last grade (% of cohort)","Preprimary education, duration (years)","Primary education, duration (years)","Primary education, pupils","Primary education, pupils (% female)","Primary education, teachers","Primary education, teachers (% female)","Primary school starting age (years)","Progression to secondary school","Public spending on education, total (% of GDP)","Pupil-teacher ratio","Ratio of young literate females to males (% ages 15-24)","Repeaters","School enrollment","School enrollment, primary, private (% of total primary)","School enrollment, secondary, private (% of total secondary)","Secondary education, duration (years)","Secondary education, general pupils","Secondary education, general pupils (% female)","Secondary education, pupils","Secondary education, pupils (% female)","Secondary education, teachers","Secondary education, teachers, female","Secondary education, teachers, female","Secondary education, vocational pupils","Secondary education, vocational pupils (% female)","Secondary school starting age (years)","Tertiary education, academic staff (% female)","Trained teachers","Access to clean fuels and technologies for cooking (% of population)","Access to electricity (% of population)","Agricultural land (sq. km)","Agricultural machinery, tractors","Agricultural machinery, tractors per 100 sq. km of arable land","Agricultural production index","Alternative and nuclear energy (% of total energy use)","Annual freshwater withdrawals (% of total)","Annual freshwater withdrawals, total (billion cubic meters)","Aquaculture production (metric tons)","Arable land (hectares per person)","Arable land (hectares)","Average precipitation in depth (mm per year)","CO2 emissions (kg per 2010 US$ of GDP)","CO2 emissions (kg per 2011 PPP $ of GDP)","CO2 emissions (kg per PPP $ of GDP)","CO2 emissions (kt)","CO2 emissions per capita","CO2 intensity (kg per kg of oil equivalent energy use)","Capture fisheries production (metric tons)","Cereal production (metric tons)","Cereal yield (kg per hectare)","Combustible renewables and waste (% of total energy)","Disaster risk reduction progress score (1-5 scale; 5=best)","Droughts, floods, extreme temperatures (% of population, average 1990-2009)",
            "Electric power transmission and distribution losses (% of output)","Electricity consumption per capita","Electricity production (% of total)","Electricity production from renewable sources, excluding hydroelectric (kWh)","Energy imports, net (% of energy use)","Energy intensity level of primary energy (MJ/$2011 PPP GDP)","Energy use (kg of oil equivalent) per $1,000 GDP (constant 2011 PPP)","Energy use per capita","Fertilizer consumption (% of fertilizer production)","Fertilizer consumption (kilograms per hectare of arable land)","Forest area (sq. km)","Fossil fuel energy consumption (% of total)","GDP per unit of energy use (PPP $ per kg of oil equivalent)","GDP per unit of energy use (constant 2011 PPP $ per kg of oil equivalent)","GHG net emissions/removals by LUCF (Mt of CO2 equivalent)","Greenhouse gas emissions (% change from 1990)","Greenhouse gas emissions (% of total)","Greenhouse gas emissions (CO2 equivalent)","Land area (sq. km)","Land area where elevation is below 5 meters (% of total land area)","Land under cereal production (hectares)","Land use (% of land area)","Level of water stress: freshwater withdrawal as a proportion of available freshwater resources","Marine protected areas (% of territorial waters)","Natural resources rents","PM2.5 air pollution, mean annual exposure (micrograms per cubic meter)","PM2.5 air pollution, population exposed to levels exceeding WHO guideline value (% of total)","Population","Population (% of total)","Population density (people per sq. km of land area)","Population in largest city","Population in the largest city (% of urban population)","Population living in areas where elevation is below 5 meters (% of total population)","Population living in slums (% of urban population)","Renewable electricity output (% of total electricity output)","Renewable energy consumption (% of total final energy consumption)","Renewable internal freshwater resources per capita (cubic meters)","Renewable internal freshwater resources, total (billion cubic meters)","Rural land area (sq. km)","Rural land area where elevation is below 5 meters (% of total land area)","Rural land area where elevation is below 5 meters (sq. km)","Rural population living in areas where elevation is below 5 meters (% of total population)","Surface area (sq. km)","Terrestrial and marine protected areas (% of total territorial area)","Terrestrial protected areas (% of total land area)","Threatened species","Total fisheries production (metric tons)","Urban land area (sq. km)","Urban land area where elevation is below 5 meters (% of total land area)","Urban land area where elevation is below 5 meters (sq. km)","Urban population living in areas where elevation is below 5 meters (% of total population)","Water productivity, total (constant 2010 US$ GDP per cubic meter of total freshwater withdrawal)","Account ownership at a financial institution or with a mobile-money-service provider (% of population ages 15+)","Account ownership at a financial institution or with a mobile-money-service provider, older adults (% of population ages 25+)","Account ownership at a financial institution or with a mobile-money-service provider, young adults (% of population ages 15-24)","Automated teller machines (ATMs) (per 100,000 adults)","Average transaction cost of sending remittances from a specific country (%)","Average transaction cost of sending remittances to a specific country (%)","Bank capital to assets ratio (%)","Bank liquid reserves to bank assets ratio (%)","Bank nonperforming loans to total gross loans (%)","Borrowers from commercial banks (per 1,000 adults)","Broad money (% of GDP)","Broad money (current LCU)","Broad money growth (annual %)","Broad money to total reserves ratio","Claims on central government (annual growth as % of broad money)","Claims on central government, etc. (% GDP)","Claims on other sectors of the domestic economy (% of GDP)","Claims on other sectors of the domestic economy (annual growth as % of broad money)","Claims on private sector (annual growth as % of broad money)","Commercial bank branches (per 100,000 adults)","Consumer price index (2005 = 100)","Depositors with commercial banks (per 1,000 adults)","Domestic credit provided by banking sector (% of GDP)","Domestic credit to private sector (% of GDP)","Domestic credit to private sector by banks (% of GDP)","Exchange rates","GDP deflator (base year varies by country)","GDP deflator: linked series (base year varies by country)","Inflation (annual %)","Interest rate","Interest rate spread (lending rate minus deposit rate, %)","Listed domestic companies, total","Market capitalization of listed companies (% of GDP)","Market capitalization of listed companies (current US$)","Net domestic credit (current LCU)","Net foreign assets (current LCU)","Risk premium on lending (prime rate minus treasury bill rate, %)","S And P Global Equity Indices (annual % change)","Stocks traded, total value (% of GDP)","Stocks traded, total value (current US$)","Stocks traded, turnover ratio (%)","Wholesale price index (2005 = 100)","Law mandates equal remuneration for females and males for work of equal value (1=yes; 0=no)","Law mandates nondiscrimination based on gender in hiring (1=yes; 0=no)","Law mandates paid or unpaid maternity leave (1=yes; 0=no)","Law prohibits or invalidates child or early marriage (1=yes; 0=no)","Legislation exists on domestic violence (1=yes; 0=no)","Mothers are guaranteed an equivalent position after maternity leave (1=yes; 0=no)","Nondiscrimination clause mentions gender in the constitution (1=yes; 0=no)","Nonpregnant and nonnursing women can do the same jobs as men (1=yes; 0=no)","Proportion of seats held by women in national parliaments (%)","Proportion of time spent on unpaid domestic and care work, female (% of 24 hour day)","Proportion of time spent on unpaid domestic and care work, male (% of 24 hour day)","Proportion of women subjected to physical and/or sexual violence in the last 12 months (% of women age 15-49)","Women making their own informed decisions regarding sexual relations, contraceptive use and reproductive health care (% of women age 15-49)","Women participating in the three decisions (own health care, major household purchases, and visiting family) (% of women age 15-49)","Women who believe a husband is justified in beating his wife(%)","ARI treatment (% of children under 5 taken to a health provider)","Adolescent fertility rate (births per 1,000 women ages 15-19)","Adults and children newly infected with HIV","Age dependency ratio","Antiretroviral therapy coverage (% of people living with HIV)","Antiretroviral therapy coverage for PMTCT (% of pregnant women living with HIV)","Birth rate, crude (per 1,000 people)","Births attended by skilled health staff (% of total)","Cause of death (% of total)","Children (0-14) living with HIV","Children with fever receiving antimalarial drugs (% of children under age 5 with fever)","Community health workers (per 1,000 people)","Completeness of birth registration","Completeness of death registration with cause-of-death information (%)","Completeness of death reporting","Completeness of infant death reporting (% of reported infant deaths to estimated infant deaths)","Condom use","Consumption of iodized salt (% of households)","Contraceptive prevalence (% of women ages 15-49)","Contraceptive prevalence, modern methods (% of women ages 15-49)","Current health expenditure (% of GDP)","Current health expenditure per capita (current US$)","Current health expenditure per capita, PPP (current international $)","Death rate, crude (per 1,000 people)","Demand for family planning satisfied by modern methods (% of married women with demand for family planning)","Depth of the food deficit (kilocalories per person per day)","Diabetes prevalence (% of population ages 20 to 79)","Diarrhea treatment (% of children under 5 receiving oral rehydration and continued feeding)","Diarrhea treatment (% of children under 5 who received ORS packet)","Domestic general government health expenditure (% of GDP)","Domestic general government health expenditure (% of current health expenditure)","Domestic general government health expenditure (% of general government expenditure)","Domestic general government health expenditure per capita (current US$)","Domestic general government health expenditure per capita, PPP (current international $)","Domestic private health expenditure (% of current health expenditure)","Domestic private health expenditure per capita (current US$)","Domestic private health expenditure per capita, PPP (current international $)","Exclusive breastfeeding (% of children under 6 months)","External health expenditure (% of current health expenditure)","External health expenditure per capita (current US$)","External health expenditure per capita, PPP (current international $)","Female genital mutilation prevalence (%)","Female headed households (% of households with a female head)","Fertility rate","HIV prevalence","Hospital beds (per 1,000 people)","Immunization, DPT (% of children ages 12-23 months)","Immunization, HepB3 (% of one-year-old children)","Immunization, measles (% of children ages 12-23 months)","Incidence of HIV (% of uninfected population ages 15-49)","Incidence of malaria (per 1,000 population at risk)","Incidence of tuberculosis (per 100,000 people)","Life expectancy","Lifetime risk of maternal death (%)","Lifetime risk of maternal death (1 in: rate varies by country)","Low-birthweight babies (% of births)","Maternal mortality","Mortality caused by road traffic injury (per 100,000 people)","Mortality from CVD, cancer, diabetes or CRD between exact ages 30 and 70 (%)","Mortality rate","Mortality rate attributed to household and ambient air pollution, age-standardized (per 100,000 population)","Mortality rate attributed to unintentional poisoning (per 100,000 population)",
            "Mortality rate attributed to unsafe water, unsafe sanitation and lack of hygiene (per 100,000 population)",
            "Newborns protected against tetanus (%)","Number of deaths","Number of maternal deaths","Number of surgical procedures (per 100,000 population)","Nurses and midwives (per 1,000 people)","Out-of-pocket expenditure (% of current health expenditure)","Out-of-pocket expenditure per capita (current US$)","Out-of-pocket expenditure per capita, PPP (current international $)","People practicing open defecation (% of population)","People using at least basic drinking water services (% of population)","People using at least basic sanitation services (% of population)","People using safely managed drinking water services (% of population)","People using safely managed sanitation services (% of population)","People with basic handwashing facilities including soap and water (% of population)","Physicians (per 1,000 people)","Population growth rate","Pregnant women receiving prenatal care (%)","Prevalence of anemia among children (% of children under 5)","Prevalence of anemia among non-pregnant women (% of women ages 15-49)","Prevalence of anemia among pregnant women (%)","Prevalence of anemia among women of reproductive age (% of women ages 15-49)","Prevalence of overweight, weight for height (% of children under 5)","Prevalence of severe wasting, weight for height (% of children under 5)","Prevalence of stunting, height for age (% of children under 5)","Prevalence of undernourishment (% of population)","Prevalence of underweight, weight for age (% of children under 5)","Prevalence of wasting, weight for height (% of children under 5)","Probability of dying at age 5-14 years (per 1,000 children age 5)","Risk of catastrophic expenditure for surgical care (% of people at risk)","Risk of impoverishing expenditure for surgical care (% of people at risk)","Sex ratio at birth (male births per female births)","Smoking prevalence","Specialist surgical workforce (per 100,000 population)","Suicide mortality rate (per 100,000 population)","Survival to age 65","Teenage mothers (% of women ages 15-19 who have had children or are currently pregnant)","Total alcohol consumption per capita (liters of pure alcohol, projected estimates, 15+ years of age)","Tuberculosis case detection rate (%, all forms)","Tuberculosis treatment success rate (% of registered cases)","Unmet need for contraception (% of married women ages 15-49)","Use of insecticide-treated bed nets (% of under-5 population)","Vitamin A supplementation coverage rate (% of children ages 6-59 months)","Wanted fertility rate (births per woman)","Women who were first married by age 15 (% of women ages 20-24)","Women who were first married by age 18 (% of women ages 20-24)","Women\'s share of population ages 15+ living with HIV (%)","Air transport, registered carrier departures worldwide","Burden of customs procedure, WEF (1=extremely inefficient to 7=extremely efficient)","Container port traffic (TEU: 20 foot equivalent units)","Fixed broadband Internet subscribers","Fixed broadband Internet subscribers (per 100 people)","Freight transport (million ton-km)","High-technology exports (% of manufactured exports)","High-technology exports (current US$)","ICT goods exports (% of total goods exports)","ICT goods imports (% total goods imports)","ICT service exports (% of service exports, BoP)","ICT service exports (BoP, current US$)","Individuals using the Internet (% of population)","Industrial design applications","Liner shipping connectivity index (maximum value in 2004 = 100)","Mobile cellular subscriptions","Mobile cellular subscriptions (per 100 people)","Passengers carried","Patent applications","Pump price for fuel","Quality of port infrastructure, WEF (1=extremely underdeveloped to 7=well developed and efficient by international standards)","Rail lines (total route-km)","Research and development expenditure (% of GDP)","Researchers in R And D (per million people)","Scientific and technical journal articles","Secure Internet servers","Secure Internet servers (per 1 million people)","Technicians in R And D (per million people)","Telephone lines","Telephone lines (per 100 people)","Trademark applications","Trademark applications by country","Labor and Social Protection","Adequacy of social protection and labor programs (% of total welfare of beneficiary households)","Average working hours of children, study and work, ages 7-14 (hours per week)","Benefit incidence of social protection and labor programs to poorest quintile (% of total SPL benefits)","Children at work (% of children ages 7-14)","Coverage of social protection and labor programs (% of population)","Employers","Employment","Employment to population ratio","Family workers","Female share of employment in senior and middle management (%)","GDP per person employed (constant 2011 PPP $)","Informal employment (% of total non-agricultural employment)","International migrant stock (% of population)","International migrant stock, total","Labor force","Labor participation rate","Net migration","Part time employment","Ratio of female to male labor force participation rate (%)","Refugee population by country or territory of asylum","Refugee population by country or territory of origin","Self-employed workers","Share of youth not in education, employment or training (% of youth population)","Unemployment","Vulnerable employment","Wage workers","Annualized average growth rate in per capita real survey mean consumption or income, bottom 40% of population (%)","Annualized average growth rate in per capita real survey mean consumption or income, total population (%)","GINI index","Income distribution","Poverty gap","Poverty gap at national poverty line","Poverty headcount ratio","Poverty headcount ratio at national poverty line","Survey mean consumption or income per capita, bottom 40% of population (2011 PPP $ per day)","Survey mean consumption or income per capita, total population (2011 PPP $ per day)","Private Sector and Trade","Average number of times firms spent in meetings with tax officials","Average time to clear exports through customs (days)","Binding coverage (%)","Bound rate (%)","Bribery incidence (% of firms experiencing at least one bribe payment request)","Business extent of disclosure index (0=less disclosure to 10=more disclosure)","Cost of business start-up procedures (% of GNI per capita)","Cost to export (US$ per container)","Cost to import (US$ per container)","Cost to trade, border compliance (US$)","Cost to trade, documentary compliance (US$)","Credit depth of information index (0=low to 6=high)","Delay in obtaining an electrical connection (days)","Distance to frontier score (0=lowest performance to 100=frontier)","Documents to trade (number)","Ease of doing business index (1=most business-friendly regulations)","Firms competing against unregistered firms (% of firms)","Firms expected to give gifts in meetings with tax officials (% of firms)","Firms experiencing electrical outages (% of firms)","Firms experiencing losses due to theft and vandalism (% of firms)","Firms formally registered when operations started (% of firms)","Firms offering formal training (% of firms)","Firms that do not report all sales for tax purposes (% of firms)","Firms that spend on R&amp;D (% of firms)","Firms using banks to finance investment (% of firms)","Firms using banks to finance working capital (% of firms)","Firms visited or required meetings with tax officials (% of firms)","Firms with female participation in ownership (% of firms)","Firms with female top manager (% of firms)","Informal payments to public officials (% of firms)","International tourism, expenditures (% of total imports)","International tourism, expenditures (current US$)","International tourism, expenditures for passenger transport items (current US$)","International tourism, expenditures for travel items (current US$)","International tourism, receipts (% of total exports)","International tourism, receipts (current US$)","International tourism, receipts for passenger transport items (current US$)","International tourism, receipts for travel items (current US$)","Investment with private participation (current US$)","Labor tax and contributions (% of commercial profits)","Lead time to trade, border compliance (hours)","Lead time to trade, documentary compliance (hours)","Lead time to trade, median case (days)","Logistics performance index","Losses due to theft, robbery, vandalism, and arson (% sales)","Management time dealing with officials (% of management time)","Merchandise exports","Merchandise imports","Merchandise trade (% of GDP)","Merchandise trade by the reporting economy (current US$)","Net barter terms of trade index (2000 = 100)","New business density (new registrations per 1,000 people ages 15-64)","New businesses registered (number)","Other taxes payable by businesses (% of commercial profits)","Power outages in firms in a typical month (number)","Private credit bureau coverage (% of adults)","Procedures to build a warehouse (number)","Procedures to register property (number)","Profit tax (% of commercial profits)","Public credit registry coverage (% of adults)","Public private partnerships investment(current US$)","Services exports","Services imports","Share of tariff lines (%)","Start-up procedures to register a business (number)","Strength of legal rights index (0=weak to 10=strong)","Tariff rate","Tax payments (number)","Time required to build a warehouse (days)","Time required to enforce a contract (days)","Time required to get electricity (days)","Time required to obtain an operating license (days)","Time required to register property (days)","Time required to start a business (days)","Time to prepare and pay taxes (hours)","Time to resolve insolvency (years)","Time to trade (days)","Total tax rate (% of commercial profits)","Tourists","Trade (current US$)","Trade unit value index (2000 = 100)","Trade value index","Trade volume index","Trading partners of developing countries (% of total)",
            "Value lost due to electrical outages (% of sales)","Armed forces personnel (% of total labor force)","Armed forces personnel, total","Arms trade (SIPRI trend indicator values)","Battle-related deaths (number of people)","CPIA Policy And institutions ratings (1=low to 6=high)","Central government debt, total (% of GDP)","Central government debt, total (current LCU)","Central government deficit And financing (% of GDP)","Central government deficit and financing (current LCU)","Central government expenses (% of total)","Central government expenses (current LCU)","Central government revenue (current LCU)","Central government revenues (% of total)","Customs and other import duties (% of tax revenue)","Customs and other import duties (current LCU)","Human capital index (HCI) (scale 0-1)","IDA resource allocation index (1=low to 6=high)","Intentional homicides","Interest payments (% of revenue)","Internally displaced persons(number of cases)","Internally displaced persons, total displaced by conflict and violence (number of people)","Methodology assessment of statistical capacity (scale 0 - 100)","Military expenditure (% of central government expenditure)","Military expenditure (current LCU)","Military expenditure (current USD)","Military expenditure as percentage of GDP","Net acquisition of financial assets (% of GDP)","Net acquisition of financial assets (current LCU)","Net incurrence of liabilities, total (% of GDP)","Net incurrence of liabilities, total (current LCU)","Net investment in nonfinancial assets (% of GDP)","Net investment in nonfinancial assets (current LCU)","Net lending (+) / net borrowing (-) (% of GDP)","Net lending (+) / net borrowing (-) (current LCU)","Overall level of statistical capacity (scale 0 - 100)","Periodicity and timeliness assessment of statistical capacity (scale 0 - 100)","Presence of peace keepers (number of troops, police, and military observers in mandate)","Source data assessment of statistical capacity (scale 0 - 100)","Tax revenue (% of GDP)","Tax revenue (current LCU)","Taxes on exports (% of tax revenue)","Taxes on exports (current LCU)","Taxes on goods and services (% value added of industry and services)","Taxes on income, profits and capital gains (% of total taxes)","Increase in poverty gap at poverty line due to out-of-pocket health care expenditure (% of poverty line)","Increase in poverty gap at poverty line due to out-of-pocket health care expenditure (USD)","Number of people pushed below the poverty line by out-of-pocket health care expenditure","Number of people spending household consumption or income on out-of-pocket health care expenditure","Proportion of population pushed below the poverty line by out-of-pocket health care expenditure (%)","Proportion of population spending household consumption or income on out-of-pocket health care expenditure (%)","UHC service coverage index"]
    frame = frame[ frame['Indicator Name'].isin(rows_req)]
    years = list(range(2000,2019))
    year_frames = dict()
    for year in years:
        year_frames[year] = pd.pivot_table(frame[['Country Name', 'Indicator Name', str(year)]], index='Country Name', columns='Indicator Name')
    return frame, year_frames

def get_year_frames(datapath):
    global cache
    dataset = get_frame(datapath)
    countries = ["Australia","Japan","South Korea","India","Philllipines","Indonesia","Bangladesh","United States","Canada","Brazil","Chile","Colombia","Mexico","South Africa","Israel","Iran","Egypt","UAE","Spain","Italy","Austria","Germany","France","United Kingdom","Russia","Switzerland", 'Finland','Ethiopia', 'Spain', 'Georgia', 'Oman', 'Lebanon', 'Luxembourg', 'Japan', 'Togo', 'Netherlands', 'Malta', 'Argentina', 'El Salvador', 'Kyrgyz Republic','Ghana', 'Cyprus', 'Philippines', 'South Africa', 'Italy', 'Iceland', 'Tanzania', 'Denmark', 'Israel', 'Ecuador', 'Kuwait', 'Estonia', 'Jamaica','Latvia', 'Namibia', 'Cambodia', 'Cameroon', 'Morocco', ]
    al_countries = ['Guatemala', 'Sweden', 'Lithuania', 'United Kingdom', 'Jordan', 'Indonesia', 'Botswana', 'Portugal', 'Costa Rica', 'Nepal', 'European Union', 'Poland', 'Hungary', 'Peru', 'Armenia', 'Uruguay', 'Slovak Republic', 'Moldova', 'Honduras', 'Ukraine', 'Canada', 'Colombia', 'Finland', 'Thailand', 'Mauritius', 'Korea, Rep.', 'Brazil', 'Sri Lanka', 'Turkey', 'Bulgaria', 'Malaysia', 'Ireland', 'Slovenia', 'Belgium', 'Ethiopia', 'Spain', 'Georgia', 'Oman', 'Lebanon', 'Luxembourg', 'Japan', 'Togo', 'Netherlands', 'Malta', 'Argentina', 'El Salvador', 'Kyrgyz Republic', 'New Zealand', 'Australia', 'Croatia', 'Paraguay', 'Angola', 'Bangladesh', 'North Macedonia', 'Russian Federation', 'Ghana', 'Cyprus', 'Philippines', 'South Africa', 'Italy', 'Iceland', 'Tanzania', 'Denmark', 'Israel', 'Ecuador', 'Kuwait', 'Estonia', 'Jamaica', 'France', 'Senegal', 'Romania', 'Czech Republic', 'Norway', 'India', 'Latvia', 'Namibia', 'Cambodia', 'Cameroon', 'Morocco', 'China', 'Switzerland', 'Belarus', 'Egypt, Arab Rep.', 'Dominican Republic', 'Kenya', 'Germany', 'Greece', 'Chile', 'United States', 'Mexico', 'Austria', 'Kazakhstan']
    selectedCountries = dataset[dataset['Country Name'].isin(countries)]
    selectedIndices = ['Country Name', 'Country Code', 'Indicator Name', 'Indicator Code', '2000', '2001', '2002', '2003', '2004',
       '2005', '2006', '2007', '2008', '2009', '2010', '2011', '2012', '2013',
       '2014', '2015', '2016', '2017']
    selectedCountryCols = selectedCountries[selectedIndices]
    education_indicators = ["Secondary education, general pupils","Secondary education, pupils","Secondary education, pupils (% female)"]
    economic_indcators = ['Trade (% of GDP)','Trade in services (% of GDP)','Foreign direct investment, net inflows (% of GDP)', 'Foreign direct investment, net inflows (BoP, current US$)', 'GDP growth rate', 'GNI (current US$)', 'GNI growth (annual %)', 'Gross Domestic Product', 'Gross domestic income (constant LCU)', 'Gross domestic savings (current US$)', 'Gross savings (% of GDP)', 'Medium and high-tech exports (% manufactured exports)', 'Net secondary income (Net current transfers from abroad) (current US$)', 'Net primary income (Net income from abroad) (current US$)', 'Services, value added per worker (constant 2010 US$)']
    env_indcators = ["Access to clean fuels and technologies for cooking (% of population)","Access to electricity (% of population)","Agricultural land (sq. km)","Alternative and nuclear energy (% of total energy use)","Aquaculture production (metric tons)","Arable land (hectares per person)","CO2 emissions (kg per 2010 US$ of GDP)","CO2 emissions (kg per 2011 PPP $ of GDP)","CO2 emissions (kg per PPP $ of GDP)","CO2 emissions (kt)","CO2 emissions per capita","CO2 intensity (kg per kg of oil equivalent energy use)","Capture fisheries production (metric tons)","Cereal production (metric tons)","Cereal yield (kg per hectare)","Combustible renewables and waste (% of total energy)", "Electric power transmission and distribution losses (% of output)","Electricity consumption per capita","Energy imports, net (% of energy use)","Energy intensity level of primary energy (MJ/$2011 PPP GDP)","Energy use (kg of oil equivalent) per $1,000 GDP (constant 2011 PPP)","Energy use per capita","Fertilizer consumption (kilograms per hectare of arable land)","Forest area (sq. km)","Fossil fuel energy consumption (% of total)","GDP per unit of energy use (PPP $ per kg of oil equivalent)","GDP per unit of energy use (constant 2011 PPP $ per kg of oil equivalent)","Greenhouse gas emissions (% change from 1990)","Greenhouse gas emissions (CO2 equivalent)","Land area (sq. km)","Land area where elevation is below 5 meters (% of total land area)","Land under cereal production (hectares)","Population in largest city","Surface area (sq. km)"]
    health_indicators = ["Age dependency ratio","Birth rate, crude (per 1,000 people)","Current health expenditure (% of GDP)","Current health expenditure per capita (current US$)","Current health expenditure per capita, PPP (current international $)","Death rate, crude (per 1,000 people)","Domestic general government health expenditure (% of GDP)","Domestic general government health expenditure (% of current health expenditure)","Domestic private health expenditure (% of current health expenditure)","Domestic private health expenditure per capita (current US$)","Domestic private health expenditure per capita, PPP (current international $)","Life Expectancy"]
    financial_indicators = ["Automated teller machines (ATMs) (per 100,000 adults)","GDP deflator (base year varies by country)","GDP deflator: linked series (base year varies by country)","Inflation (annual %)","Net foreign assets (current LCU)"]
    gender_indcators = ["Proportion of seats held by women in national parliaments (%)"]
    infra_indcators = ["Air transport, registered carrier departures worldwide","Container port traffic (TEU: 20 foot equivalent units)","Fixed broadband Internet subscribers","Fixed broadband Internet subscribers (per 100 people)","ICT goods exports (% of total goods exports)","ICT goods imports (% total goods imports)","Individuals using the Internet (% of population)","Mobile cellular subscriptions","Mobile cellular subscriptions (per 100 people)","Scientific and technical journal articles"]
    labor_indicators = ["GDP per person employed (constant 2011 PPP $)","Refugee population by country or territory of asylum"]
    private_indicators = ["Cost of business start-up procedures (% of GNI per capita)","Credit depth of information index (0=low to 6=high)","Distance to frontier score (0=lowest performance to 100=frontier)","International tourism, expenditures (% of total imports)","International tourism, expenditures (current US$)","International tourism, receipts (% of total exports)","International tourism, receipts (current US$)"]
    public_indicators = ["Armed forces personnel (% of total labor force)","Armed forces personnel, total","Intentional homicides","Military expenditure (% of central government expenditure)","Military expenditure (current USD)","Military expenditure as percentage of GDP","Net lending (+) / net borrowing (-) (% of GDP)","Net lending (+) / net borrowing (-) (current LCU)","Tax revenue (% of GDP)","Tax revenue (current LCU)"]
    indicators = economic_indcators + env_indcators + health_indicators + financial_indicators + gender_indcators + infra_indcators + labor_indicators + private_indicators + public_indicators + education_indicators
    economic_values = selectedCountryCols[selectedCountryCols['Indicator Name'].isin(indicators)]
    year_frames = dict()
    for y in range(2000,2018):
        year_frames[y] = pd.pivot_table(economic_values[['Country Name', 'Indicator Name', str(y)]], index='Country Name', columns='Indicator Name')
        year_frames[y].columns = year_frames[y].columns.droplevel(0)
        year_frames[y].columns.name = None
        year_frames[y] =  year_frames[y].reset_index()
        for col in indicators:
            if col not in year_frames[y].columns:
                year_frames[y][col] = 0
        year_frames[y].fillna(0, inplace=True)
    return year_frames

def perform_pca(data_frame):
    pca = PCA(n_components=np.min(data_frame.shape))
    min_max_scalar = MinMaxScaler()
    data_frame[data_frame.columns] = min_max_scalar.fit_transform(data_frame[data_frame.columns])
    pca.fit(data_frame)

    #retrieve the columsn of the data
    cols = data_frame.columns
    print(pca.explained_variance_ratio_)
    ratio_values = pca.explained_variance_ratio_ * 100

    # find the intrinsic index of the data
    intrinsic_index = 0
    for i, val in enumerate(np.cumsum(ratio_values).tolist()):
        if val < 75.0:
            intrinsic_index = i

    sum_values = np.sum(np.square(pca.components_.T * np.sqrt(pca.explained_variance_)), axis = 0)
    top_cols = data_frame.columns[sum_values.argsort()[::-1]]
    transformed_data = pca.transform(data_frame)[:, :2].tolist()
    return ratio_values, top_cols, transformed_data

def get_pca_frames(datapath):
    year_frames = get_year_frames(datapath)
    for i in range(2000,2018):
            year_wise = dict()
            year_frames[i] = year_frames[i].fillna(0)
            r, t, d = perform_pca(year_frames[i][[x for x in year_frames[i].columns if x != 'Country Name']])
            year_wise["cumulative_sum"] = np.cumsum(r).tolist()
            year_wise["top_attrs"] = t.to_list()[:5]
            year_wise["PCA_dims"] = d
            year_frames[i] = year_wise
    return year_frames

def get_mds_data(datapath):
    global cache
    response = dict()
    if 'mds_frames' in cache and 'countries' in cache:
        response['mds_frames'] = cache['mds_frames']
        response['countries'] = cache['countries']
        return response 
    year_frames = get_year_frames(datapath)
    mds_frames = dict()
    countries = []
    for y in year_frames:
        response_frame =  year_frames[y].copy().set_index('Country Name')
        response_frame.fillna(0, inplace=True) 
        min_max_scalar = MinMaxScaler()
        countries = year_frames[y]['Country Name'].tolist()
        response_frame[response_frame.columns] = min_max_scalar.fit_transform(response_frame[response_frame.columns])
        euclidean_distances_matrix = pairwise_distances(response_frame, metric='euclidean')
        mds = MDS(n_components= 2, dissimilarity="precomputed")
        mds_frames[y] = mds.fit_transform(euclidean_distances_matrix).tolist()
    response['mds_frames'] = mds_frames
    response['countries'] = countries
    return response